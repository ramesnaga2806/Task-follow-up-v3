<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Video OCR (English + Tamil)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f3f3;
      margin: 10px;
      text-align: center;
    }
    h2 {
      color: #333;
    }
    video {
      width: 100%;
      max-height: 60vh;
      border-radius: 10px;
      border: 2px solid #ccc;
      background: #000;
      object-fit: cover;
      margin-top: 10px;
    }
    button, select {
      padding: 10px 14px;
      margin: 6px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled {
      background: #aaa;
    }
    #output {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      white-space: pre-wrap;
      text-align: left;
      min-height: 100px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>ðŸ“· Live Video OCR (English + Tamil)</h2>
  <select id="facing">
    <option value="environment">Back Camera</option>
    <option value="user">Front Camera</option>
  </select>
  <button id="start">Start Camera</button>
  <button id="stop" disabled>Stop</button>
  <button id="download" disabled>Download as CSV</button>
  <video id="video" autoplay playsinline></video>
  <div id="output">Text will appear here...</div>

  <!-- Load Tesseract.js (OCR Engine) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const output = document.getElementById('output');
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const downloadBtn = document.getElementById('download');
    const facing = document.getElementById('facing');

    let stream = null;
    let running = false;
    let textData = [['Timestamp', 'Recognized Text']]; // CSV header

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: facing.value }, audio: false
        });
        video.srcObject = stream;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        downloadBtn.disabled = true;
        running = true;
        output.textContent = 'Starting OCR...';
        runLiveOCR();
      } catch (err) {
        output.textContent = 'Camera Error: ' + err.message;
      }
    }

    function stopCamera() {
      running = false;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      downloadBtn.disabled = textData.length <= 1; // Disable if no data
      output.textContent = textData.length > 1 ? output.textContent : 'No text recognized.';
    }

    async function runLiveOCR() {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Load OCR worker (English + Tamil)
        const worker = await Tesseract.createWorker(['eng', 'tam']);
        
        while (running) {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const { data: { text } } = await worker.recognize(canvas);
            const clean = text.trim();
            if (clean) {
              output.textContent = clean;
              const timestamp = new Date().toISOString();
              textData.push([timestamp, clean.replace(/"/g, '""')]); // Escape quotes for CSV
            }
          }
          // Add delay to reduce CPU usage (1 second)
          await new Promise(resolve => setTimeout(resolve, 1000));
        }

        await worker.terminate();
      } catch (err) {
        output.textContent = 'OCR Error: ' + err.message;
      }
    }

    function downloadText() {
      if (textData.length <= 1) {
        alert('No text to download.');
        return;
      }
      // Convert textData to CSV
      const csvContent = textData
        .map(row => `"${row[0]}","${row[1]}"`) // Wrap fields in quotes
        .join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'recognized_text.csv';
      a.click();
    }

    startBtn.onclick = startCamera;
    stopBtn.onclick = stopCamera;
    downloadBtn.onclick = downloadText;
  </script>
</body>
</html>
